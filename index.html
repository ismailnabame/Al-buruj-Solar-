
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Al Buruj Solar • Business Portal</title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ========== RESET & VARIABLES ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    :root {
      --primary: #0d7eb8;
      --secondary: #4fc3f7;
      --accent: #29b6f6;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --light: #e3f2fd;
      --dark: #1565c0;
      --gray: #78909c;
      --card-shadow: 0 8px 25px rgba(13, 126, 184, 0.1);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    body {
      background: #f5f7fa;
      color: #333;
    }
    /* ========== LOADER ========== */
    #global-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      pointer-events: all;
    }
    .loader-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #e3f2fd;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    .loader-text { color: var(--primary); font-weight: 500; }

    /* ========== TOAST ========== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9998;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }
    .toast-success { background: var(--success); }
    .toast-error { background: var(--danger); }
    .toast-warning { background: var(--warning); }
    .toast-info { background: var(--secondary); }
    .toast-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
      opacity: 0.8;
    }

    /* ========== LOGIN PAGE ========== */
    #login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 50%, #0288d1 100%);
    }
    .login-container {
      background: #fff;
      padding: 40px;
      border-radius: 15px;
      box-shadow: var(--card-shadow);
      width: 100%;
      max-width: 450px;
      text-align: center;
    }
    .logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 20px;
      background: url('https://i.postimg.cc/MTJn43gD/Screenshot-20260127-214753.jpg') center/contain no-repeat;
    }
    .login-container h1 { color: var(--primary); margin-bottom: 10px; }
    .login-container p { color: var(--gray); margin-bottom: 30px; }
    .form-group { margin-bottom: 20px; text-align: left; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: var(--transition);
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13,126,184,0.2);
    }
    .login-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    .login-btn:hover {
      background: #0a6da5;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .error-message { color: var(--danger); margin-top: 15px; display: none; }

    /* ========== MAIN APP LAYOUT ========== */
    #app { display: none; min-height: 100vh; }
    header {
      background: #fff;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 3px solid var(--primary);
    }
    .header-left { display: flex; align-items: center; }
    .header-logo {
      width: 50px;
      height: 50px;
      margin-right: 15px;
      background: url('https://i.postimg.cc/MTJn43gD/Screenshot-20260127-214753.jpg') center/contain no-repeat;
    }
    header h1 { color: var(--primary); font-size: 20px; font-weight: 600; }
    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
      color: #555;
    }
    .user-info span { font-weight: 500; }
    .logout-btn {
      background: var(--danger);
      color: #fff;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }
    .logout-btn:hover { background: #d32f2f; transform: translateY(-2px); }

    /* ========== SIDEBAR ========== */
    .sidebar {
      width: 280px;
      background: #fff;
      height: calc(100vh - 70px);
      position: fixed;
      left: 0;
      top: 70px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      overflow-y: auto;
      border-right: 2px solid #e3f2fd;
    }
    .sidebar-menu {
      list-style: none;
      padding: 20px 0;
    }
    .sidebar-menu li {
      padding: 12px 25px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #444;
      transition: var(--transition);
      border-left: 4px solid transparent;
      margin: 5px 0;
    }
    .sidebar-menu li i { width: 20px; text-align: center; color: var(--primary); }
    .sidebar-menu li:hover {
      background: rgba(13,126,184,0.05);
      border-left: 4px solid var(--accent);
      color: var(--primary);
    }
    .sidebar-menu li.active {
      background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);
      color: var(--primary);
      font-weight: 600;
      border-left: 4px solid var(--primary);
    }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      margin-left: 280px;
      padding: 30px;
      min-height: calc(100vh - 70px);
    }
    .module-section { display: none; animation: fadeIn 0.5s ease; }
    .module-section.active { display: block; }

    /* ========== CARDS & TABLES ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      border-top: 4px solid var(--primary);
    }
    .stat-card h3 { font-size: 14px; color: var(--gray); margin-bottom: 10px; }
    .stat-card .value { font-size: 28px; font-weight: 600; color: var(--primary); }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      padding: 25px;
      margin-bottom: 30px;
      overflow-x: auto;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .card-header h3 { color: var(--primary); font-size: 18px; }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--primary);
    }
    tr:hover { background: rgba(13,126,184,0.03); }

    /* Status colors */
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-danger { color: var(--danger); }
    .text-info { color: var(--secondary); }

    /* ========== BUTTONS ========== */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      font-weight: 500;
      font-size: 14px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #0a6da5; transform: translateY(-2px); }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    .btn-outline:hover { background: var(--primary); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { background: #d32f2f; }
    .btn-success { background: var(--success); color: #fff; }

    /* ========== FILTERS ========== */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }
    .filters input, .filters select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      min-width: 200px;
    }

    /* ========== MODALS ========== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-content {
      background: #fff;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);
    }
    .modal-header h2 { color: var(--primary); margin: 0; }
    .close-modal {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #555;
    }
    .close-modal:hover { color: var(--danger); }
    .modal-body { padding: 20px; }
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-row .form-group { flex: 1; margin-bottom: 0; }
    .form-actions {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: #f8f9fa;
    }

    /* ========== SERVICE BADGES ========== */
    .service-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .service-contract { background: #e8f5e9; color: #2e7d32; }
    .service-consultancy { background: #e3f2fd; color: #1565c0; }
    .service-installation { background: #fff3e0; color: #ef6c00; }
    .service-maintenance { background: #f3e5f5; color: #7b1fa2; }
    .service-supply { background: #e0f2f1; color: #00695c; }

    /* ========== ANIMATIONS ========== */
    @keyframes spin { 100% { transform: rotate(360deg); } }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="global-loader">
    <div class="loader-spinner"></div>
    <div class="loader-text">Loading...</div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Login Page -->
  <div id="login-page">
    <div class="login-container">
      <div class="logo"></div>
      <h1>Al Buruj Solar</h1>
      <p>Business Management System</p>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="Enter your email" value="admin@alburuj.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" placeholder="Enter your password" value="password123">
      </div>
      <div class="form-group">
        <label>Role</label>
        <select id="role-select">
          <option value="">Select Role</option>
          <option value="Admin" selected>Admin</option>
          <option value="Sales">Sales</option>
          <option value="Inventory">Inventory</option>
        </select>
      </div>
      <button class="login-btn" onclick="login()">Login</button>
      <div id="login-error" class="error-message"></div>
      <div style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; text-align: left;">
        <p><strong>Test Credentials:</strong></p>
        <p>Email: admin@alburuj.com</p>
        <p>Password: password123</p>
        <p>Role: Admin</p>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="app">
    <header>
      <div class="header-left">
        <div class="header-logo"></div>
        <h1>Al Buruj Solar Business Portal</h1>
      </div>
      <div class="user-info">
        <span id="date-display"></span>
        <span id="user-role-display"></span>
        <span id="username-display"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar">
      <ul class="sidebar-menu">
        <li data-target="dashboard-module" class="menu-item"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
        <li data-target="admin-module" class="menu-item admin-only"><i class="fas fa-user-shield"></i> Admin Panel</li>
        <li data-target="customers-module" class="menu-item sales-only admin-only"><i class="fas fa-users"></i> Customers</li>
        <li data-target="inventory-module" class="menu-item inventory-only admin-only"><i class="fas fa-boxes"></i> Inventory</li>
        <li data-target="sales-module" class="menu-item sales-only admin-only"><i class="fas fa-shopping-cart"></i> Sales</li>
        <li data-target="installations-module" class="menu-item sales-only admin-only inventory-only"><i class="fas fa-solar-panel"></i> Installations</li>
        <li data-target="financial-module" class="menu-item admin-only"><i class="fas fa-file-invoice-dollar"></i> Financials</li>
        <li data-target="services-module" class="menu-item admin-only sales-only"><i class="fas fa-concierge-bell"></i> Services Overview</li>
      </ul>
    </div>

    <div class="main-content">
      <!-- Dashboard Module -->
      <div id="dashboard-module" class="module-section">
        <div class="section-header">
          <h2>Dashboard</h2>
          <button class="btn btn-outline" onclick="loadDashboard()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Sales (Month)</h3><div class="value" id="total-sales-month">₦0</div></div>
          <div class="stat-card"><h3>Active Projects</h3><div class="value" id="active-projects">0</div></div>
          <div class="stat-card"><h3>Low Stock Items</h3><div class="value" id="low-stock-count">0</div></div>
          <div class="stat-card"><h3>Total Customers</h3><div class="value" id="total-customers">0</div></div>
        </div>
        <div class="row" style="display: flex; gap: 20px;">
          <div style="flex:1; background: #fff; padding: 20px; border-radius: 10px;">
            <h3>Service Distribution</h3>
            <canvas id="serviceChart"></canvas>
          </div>
          <div style="flex:1; background: #fff; padding: 20px; border-radius: 10px;">
            <h3>Monthly Sales</h3>
            <canvas id="salesChart"></canvas>
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-header"><h3>Recent Sales</h3></div>
          <table>
            <thead><tr><th>Sale #</th><th>Customer</th><th>Service</th><th>Amount</th><th>Date</th><th>Status</th></tr></thead>
            <tbody id="recent-sales-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Admin Module -->
      <div id="admin-module" class="module-section">
        <div class="section-header">
          <h2>Admin Panel</h2>
          <button class="btn btn-primary" onclick="showAddUserModal()"><i class="fas fa-user-plus"></i> Add User</button>
        </div>
        <div class="card">
          <div class="card-header"><h3>Users</h3></div>
          <table>
            <thead><tr><th>Username</th><th>Full Name</th><th>Role</th><th>Email</th><th>Last Login</th><th>Actions</th></tr></thead>
            <tbody id="users-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Customers Module -->
      <div id="customers-module" class="module-section">
        <div class="section-header">
          <h2>Customers</h2>
          <button class="btn btn-primary" onclick="showAddCustomerModal()"><i class="fas fa-user-plus"></i> Add Customer</button>
        </div>
        <div class="filters">
          <input type="text" id="customer-search" placeholder="Search customers..." onkeyup="filterCustomers()">
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Code</th><th>Name</th><th>Email</th><th>Phone</th><th>Type</th><th>Actions</th></tr></thead>
            <tbody id="customers-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Inventory Module -->
      <div id="inventory-module" class="module-section">
        <div class="section-header">
          <h2>Inventory</h2>
          <button class="btn btn-primary" onclick="showAddProductModal()"><i class="fas fa-plus"></i> Add Product</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Products</h3><div class="value" id="total-products">0</div></div>
          <div class="stat-card"><h3>Inventory Value</h3><div class="value" id="inventory-value">₦0</div></div>
          <div class="stat-card"><h3>Low Stock</h3><div class="value" id="low-stock-inventory">0</div></div>
        </div>
        <div class="filters">
          <input type="text" id="inventory-search" placeholder="Search products..." onkeyup="filterInventory()">
          <select id="inventory-category" onchange="filterInventory()">
            <option value="all">All Categories</option>
            <option value="Solar Panels">Solar Panels</option>
            <option value="Batteries">Batteries</option>
            <option value="Inverters">Inverters</option>
            <option value="Charge Controllers">Charge Controllers</option>
            <option value="Cables">Cables</option>
            <option value="Accessories">Accessories</option>
          </select>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>SKU</th><th>Product</th><th>Category</th><th>Qty</th><th>Cost</th><th>Selling</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="inventory-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Sales Module -->
      <div id="sales-module" class="module-section">
        <div class="section-header">
          <h2>Sales</h2>
          <button class="btn btn-primary" onclick="showAddSaleModal()"><i class="fas fa-plus"></i> New Sale</button>
        </div>
        <div class="filters">
          <input type="text" id="sales-search" placeholder="Search sales..." onkeyup="filterSales()">
          <select id="sales-service-filter" onchange="filterSales()">
            <option value="all">All Services</option>
            <option value="Contract">Contract</option>
            <option value="Consultancy">Consultancy</option>
            <option value="Installation">Installation</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Supply">Supply</option>
          </select>
          <select id="sales-status-filter" onchange="filterSales()">
            <option value="all">All Status</option>
            <option value="Draft">Draft</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Sale #</th><th>Customer</th><th>Service</th><th>Amount</th><th>Date</th><th>Payment</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="sales-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Installations Module -->
      <div id="installations-module" class="module-section">
        <div class="section-header">
          <h2>Installations</h2>
          <button class="btn btn-primary" onclick="showAddInstallationModal()"><i class="fas fa-plus"></i> Add Installation</button>
        </div>
        <div class="filters">
          <input type="text" id="install-search" placeholder="Search..." onkeyup="filterInstallations()">
          <select id="install-status-filter" onchange="filterInstallations()">
            <option value="all">All Status</option>
            <option value="Scheduled">Scheduled</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Project ID</th><th>Customer</th><th>Location</th><th>Panels</th><th>Total Watts</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="installations-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Financial Module -->
      <div id="financial-module" class="module-section">
        <div class="section-header">
          <h2>Financial Overview</h2>
          <button class="btn btn-success" onclick="loadFinancials()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Income</h3><div class="value" id="total-income">₦0</div></div>
          <div class="stat-card"><h3>Total Expenses</h3><div class="value" id="total-expenses">₦0</div></div>
          <div class="stat-card"><h3>Net Profit</h3><div class="value" id="net-profit">₦0</div></div>
          <div class="stat-card"><h3>Gross Profit</h3><div class="value" id="gross-profit">₦0</div></div>
        </div>
        <div class="row" style="display: flex; gap: 20px;">
          <div style="flex:1; background: #fff; padding: 20px; border-radius: 10px;">
            <h3>Income by Service</h3>
            <canvas id="incomeChart"></canvas>
          </div>
          <div style="flex:1; background: #fff; padding: 20px; border-radius: 10px;">
            <h3>Monthly Profit Trend</h3>
            <canvas id="profitChart"></canvas>
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-header"><h3>Recent Transactions</h3></div>
          <table>
            <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th></tr></thead>
            <tbody id="transactions-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Services Overview Module -->
      <div id="services-module" class="module-section">
        <div class="section-header"><h2>Services Overview</h2></div>
        <div class="stats-grid">
          <div class="stat-card"><h3>Contracts</h3><div class="value" id="contracts-count">0</div></div>
          <div class="stat-card"><h3>Consultancy</h3><div class="value" id="consultancy-count">0</div></div>
          <div class="stat-card"><h3>Installations</h3><div class="value" id="installations-count">0</div></div>
          <div class="stat-card"><h3>Maintenance</h3><div class="value" id="maintenance-count">0</div></div>
          <div class="stat-card"><h3>Supply</h3><div class="value" id="supply-count">0</div></div>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Service</th><th>Total Sales</th><th>Revenue</th></tr></thead>
            <tbody id="services-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div id="add-customer-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Add Customer</h2><button class="close-modal" onclick="closeModal('add-customer-modal')">&times;</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label>Name*</label><input id="customer-name"></div>
          <div class="form-group"><label>Email</label><input type="email" id="customer-email"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Phone</label><input id="customer-phone"></div>
          <div class="form-group"><label>Type</label>
            <select id="customer-type">
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Government">Government</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Address</label><input id="customer-address"></div>
          <div class="form-group"><label>City</label><input id="customer-city"></div>
        </div>
        <input type="hidden" id="customer-id">
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeModal('add-customer-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCustomer()">Save</button>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="add-product-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Add Product</h2><button class="close-modal" onclick="closeModal('add-product-modal')">&times;</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label>Product Name*</label><input id="product-name"></div>
          <div class="form-group"><label>Category*</label>
            <select id="product-category">
              <option value="Solar Panels">Solar Panels</option>
              <option value="Batteries">Batteries</option>
              <option value="Inverters">Inverters</option>
              <option value="Charge Controllers">Charge Controllers</option>
              <option value="Cables">Cables</option>
              <option value="Accessories">Accessories</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Specification</label><input id="product-spec"></div>
          <div class="form-group"><label>Quantity*</label><input type="number" id="product-quantity" value="0"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Cost Price (₦)*</label><input type="number" id="product-cost"></div>
          <div class="form-group"><label>Selling Price (₦)*</label><input type="number" id="product-selling"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Supplier Name</label><input id="product-supplier"></div>
          <div class="form-group"><label>Min Stock Level</label><input type="number" id="product-min-level" value="5"></div>
        </div>
        <input type="hidden" id="product-id">
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeModal('add-product-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveProduct()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ========== SUPABASE INITIALIZATION ==========
    const SUPABASE_URL = 'https://cstzpeannerdvwyxpfph.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_SEiYbtYlFn8YShWyPa_vSQ_ZF_-yiym';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global state
    let currentUser = null;
    let customers = [];
    let inventoryItems = [];
    let sales = [];
    let installations = [];
    let users = [];

    // Chart instances
    let serviceChart, salesChart, incomeChart, profitChart;

    // ========== UTILITY FUNCTIONS ==========
    function showLoader(message = 'Loading...') {
      document.getElementById('global-loader').style.display = 'flex';
      document.querySelector('.loader-text').textContent = message;
    }
    
    function hideLoader() {
      document.getElementById('global-loader').style.display = 'none';
    }
    
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      const msgSpan = document.createElement('span');
      msgSpan.className = 'toast-message';
      msgSpan.textContent = message;
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'toast-close';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = function() { toast.remove(); };
      
      toast.appendChild(msgSpan);
      toast.appendChild(closeBtn);
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }
    
    function escapeHTML(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"]/g, function(m) {
        return { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[m];
      });
    }
    
    function formatCurrency(amount) {
      return '₦' + Number(amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      return new Date(dateStr).toLocaleDateString('en-NG', { day: '2-digit', month: 'short', year: 'numeric' });
    }
    
    function formatDateTime(dateStr) {
      if (!dateStr) return 'N/A';
      return new Date(dateStr).toLocaleString('en-NG');
    }
    
    function showModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Close modal when clicking outside content
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal(this.id);
      });
    });

    // ========== AUTHENTICATION ==========
    async function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('role-select').value;

      console.log('Login attempt:', { email, role }); // Debug log

      if (!email || !password || !role) {
        showToast('All fields are required', 'error');
        return;
      }

      showLoader('Authenticating...');
      
      try {
        // First, try to sign in
        const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        console.log('Auth response:', authData, authError); // Debug log

        if (authError) {
          console.error('Auth error:', authError);
          
          // Check if user doesn't exist, create test user
          if (authError.message.includes('Invalid login credentials')) {
            showToast('Invalid credentials. Creating test user...', 'warning');
            
            // Try to create a test user
            const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
              email: 'admin@alburuj.com',
              password: 'password123',
              options: {
                data: {
                  full_name: 'Admin User',
                  role: 'Admin'
                }
              }
            });
            
            if (signUpError) {
              throw new Error('Could not create user: ' + signUpError.message);
            }
            
            if (signUpData.user) {
              // Create profile
              const { error: profileError } = await supabase
                .from('profiles')
                .insert([{
                  id: signUpData.user.id,
                  username: 'admin',
                  full_name: 'Admin User',
                  email: 'admin@alburuj.com',
                  role: 'Admin',
                  created_at: new Date().toISOString()
                }]);
              
              if (profileError) {
                console.error('Profile creation error:', profileError);
              }
              
              showToast('Test user created! Please try logging in again.', 'success');
            }
          } else {
            throw authError;
          }
          return;
        }

        if (!authData?.user) {
          throw new Error('No user data received');
        }

        // Fetch profile
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', authData.user.id)
          .single();

        console.log('Profile response:', profile, profileError); // Debug log

        if (profileError) {
          // If profile doesn't exist, create it
          if (profileError.code === 'PGRST116') {
            const { data: newProfile, error: insertError } = await supabase
              .from('profiles')
              .insert([{
                id: authData.user.id,
                username: email.split('@')[0],
                full_name: email.split('@')[0],
                email: email,
                role: role,
                created_at: new Date().toISOString()
              }])
              .select()
              .single();

            if (insertError) {
              throw new Error('Could not create profile: ' + insertError.message);
            }

            currentUser = newProfile;
          } else {
            throw profileError;
          }
        } else {
          if (profile.role !== role) {
            throw new Error('Role mismatch. Please select the correct role.');
          }
          currentUser = profile;
        }

        // Update last login
        await supabase
          .from('profiles')
          .update({ last_login: new Date().toISOString() })
          .eq('id', currentUser.id);

        // Save to localStorage
        localStorage.setItem('alburuj_user', JSON.stringify(currentUser));

        // Update UI
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('username-display').textContent = currentUser.full_name;
        document.getElementById('user-role-display').textContent = currentUser.role;
        updateDateDisplay();
        applyRoleVisibility(currentUser.role);

        // Load default module
        showModule('dashboard-module');
        
        showToast('Login successful!', 'success');

      } catch (error) {
        console.error('Login error:', error);
        document.getElementById('login-error').style.display = 'block';
        document.getElementById('login-error').textContent = error.message;
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      localStorage.removeItem('alburuj_user');
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
      currentUser = null;
    }

    function updateDateDisplay() {
      const now = new Date();
      document.getElementById('date-display').textContent = now.toLocaleDateString('en-NG', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }

    function applyRoleVisibility(role) {
      document.querySelectorAll('.menu-item').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.menu-item').forEach(el => {
        if (el.classList.contains(role.toLowerCase() + '-only') || role === 'Admin') {
          el.style.display = 'flex';
        }
      });
      // Admin sees all
      if (role === 'Admin') {
        document.querySelectorAll('.menu-item').forEach(el => el.style.display = 'flex');
      }
    }

    function showModule(moduleId) {
      document.querySelectorAll('.module-section').forEach(m => m.classList.remove('active'));
      document.getElementById(moduleId).classList.add('active');

      // Load data based on module
      if (moduleId === 'dashboard-module') loadDashboard();
      else if (moduleId === 'admin-module') loadUsers();
      else if (moduleId === 'customers-module') loadCustomers();
      else if (moduleId === 'inventory-module') loadInventory();
      else if (moduleId === 'sales-module') loadSales();
      else if (moduleId === 'installations-module') loadInstallations();
      else if (moduleId === 'financial-module') loadFinancials();
      else if (moduleId === 'services-module') loadServicesOverview();
    }

    // ========== DASHBOARD ==========
    async function loadDashboard() {
      showLoader('Loading dashboard...');
      try {
        if (serviceChart) serviceChart.destroy();
        if (salesChart) salesChart.destroy();

        // Stats
        document.getElementById('total-sales-month').innerText = formatCurrency(0);
        document.getElementById('active-projects').innerText = '0';
        document.getElementById('low-stock-count').innerText = '0';
        document.getElementById('total-customers').innerText = customers.length || '0';

        // Recent sales
        const tbody = document.getElementById('recent-sales-body');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No recent sales</td></tr>';

        // Service distribution chart
        serviceChart = new Chart(document.getElementById('serviceChart'), {
          type: 'doughnut',
          data: {
            labels: ['No Data'],
            datasets: [{ data: [1], backgroundColor: ['#ccc'] }]
          }
        });

        // Monthly sales chart
        salesChart = new Chart(document.getElementById('salesChart'), {
          type: 'line',
          data: {
            labels: ['No Data'],
            datasets: [{ label: 'Sales (₦)', data: [0], borderColor: '#2196f3', fill: false }]
          }
        });

      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== ADMIN: USER MANAGEMENT ==========
    async function loadUsers() {
      showLoader('Loading users...');
      try {
        const { data, error } = await supabase.from('profiles').select('*').order('created_at');
        if (error) throw error;
        users = data || [];
        const tbody = document.getElementById('users-table-body');
        tbody.innerHTML = '';
        if (users.length) {
          users.forEach(u => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${escapeHTML(u.username || '')}</td>
              <td>${escapeHTML(u.full_name)}</td>
              <td>${escapeHTML(u.role)}</td>
              <td>${escapeHTML(u.email)}</td>
              <td>${escapeHTML(u.last_login ? formatDateTime(u.last_login) : 'Never')}</td>
              <td>
                <button class="btn btn-outline btn-sm" onclick="editUser('${u.id}')">Edit</button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found</td></tr>';
        }
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function showAddUserModal() {
      showToast('User creation requires a backend function. Use Supabase dashboard.', 'warning');
    }

    // ========== CUSTOMERS ==========
    async function loadCustomers() {
      showLoader('Loading customers...');
      try {
        const { data, error } = await supabase.from('customers').select('*').order('name');
        if (error) throw error;
        customers = data || [];
        renderCustomersTable(customers);
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function filterCustomers() {
      const term = document.getElementById('customer-search').value.toLowerCase();
      const filtered = customers.filter(c => 
        c.name.toLowerCase().includes(term) || (c.email && c.email.toLowerCase().includes(term))
      );
      renderCustomersTable(filtered);
    }

    function renderCustomersTable(custs) {
      const tbody = document.getElementById('customers-table-body');
      tbody.innerHTML = '';
      if (custs.length) {
        custs.forEach(c => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(c.customer_code || '')}</td>
            <td>${escapeHTML(c.name)}</td>
            <td>${escapeHTML(c.email || '')}</td>
            <td>${escapeHTML(c.phone || '')}</td>
            <td>${escapeHTML(c.customer_type || '')}</td>
            <td>
              <button class="btn btn-outline btn-sm" onclick="editCustomer('${c.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${c.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No customers found</td></tr>';
      }
    }

    function showAddCustomerModal() {
      document.getElementById('customer-id').value = '';
      document.getElementById('customer-name').value = '';
      document.getElementById('customer-email').value = '';
      document.getElementById('customer-phone').value = '';
      document.getElementById('customer-type').value = 'Individual';
      document.getElementById('customer-address').value = '';
      document.getElementById('customer-city').value = '';
      showModal('add-customer-modal');
    }

    async function saveCustomer() {
      const id = document.getElementById('customer-id').value;
      const name = document.getElementById('customer-name').value.trim();
      const email = document.getElementById('customer-email').value.trim();
      const phone = document.getElementById('customer-phone').value.trim();
      const type = document.getElementById('customer-type').value;
      const address = document.getElementById('customer-address').value.trim();
      const city = document.getElementById('customer-city').value.trim();

      if (!name) { showToast('Name is required', 'error'); return; }

      showLoader('Saving...');
      try {
        if (id) {
          const { error } = await supabase.from('customers').update({ 
            name, email, phone, customer_type: type, address, city 
          }).eq('id', id);
          if (error) throw error;
          showToast('Customer updated', 'success');
        } else {
          const customerCode = 'CUST-' + Date.now().toString().slice(-6);
          const { error } = await supabase.from('customers').insert([{
            customer_code: customerCode,
            name, email, phone, customer_type: type, address, city,
            created_by: currentUser?.id
          }]);
          if (error) throw error;
          showToast('Customer added', 'success');
        }
        closeModal('add-customer-modal');
        loadCustomers();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function editCustomer(id) {
      const cust = customers.find(c => c.id === id);
      if (!cust) return;
      document.getElementById('customer-id').value = cust.id;
      document.getElementById('customer-name').value = cust.name;
      document.getElementById('customer-email').value = cust.email || '';
      document.getElementById('customer-phone').value = cust.phone || '';
      document.getElementById('customer-type').value = cust.customer_type || 'Individual';
      document.getElementById('customer-address').value = cust.address || '';
      document.getElementById('customer-city').value = cust.city || '';
      showModal('add-customer-modal');
    }

    async function deleteCustomer(id) {
      if (!confirm('Delete customer?')) return;
      showLoader('Deleting...');
      try {
        const { error } = await supabase.from('customers').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        loadCustomers();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== INVENTORY ==========
    async function loadInventory() {
      showLoader('Loading inventory...');
      try {
        const { data, error } = await supabase.from('inventory').select('*').order('product_name');
        if (error) throw error;
        inventoryItems = data || [];
        
        // Calculate stats
        const totalProducts = inventoryItems.length;
        const totalValue = inventoryItems.reduce((sum, item) => sum + (item.cost_price * item.quantity), 0);
        const lowStock = inventoryItems.filter(item => item.quantity <= (item.min_stock_level || 5)).length;
        
        document.getElementById('total-products').innerText = totalProducts;
        document.getElementById('inventory-value').innerText = formatCurrency(totalValue);
        document.getElementById('low-stock-inventory').innerText = lowStock;
        
        renderInventoryTable(inventoryItems);
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function filterInventory() {
      const term = document.getElementById('inventory-search').value.toLowerCase();
      const cat = document.getElementById('inventory-category').value;
      const filtered = inventoryItems.filter(i => 
        (i.product_name.toLowerCase().includes(term) || (i.sku && i.sku.toLowerCase().includes(term))) &&
        (cat === 'all' || i.category === cat)
      );
      renderInventoryTable(filtered);
    }

    function renderInventoryTable(items) {
      const tbody = document.getElementById('inventory-table-body');
      tbody.innerHTML = '';
      if (items.length) {
        items.forEach(i => {
          const status = i.quantity === 0 ? 'Out of Stock' : (i.quantity <= (i.min_stock_level || 5) ? 'Low Stock' : 'In Stock');
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(i.sku || '')}</td>
            <td>${escapeHTML(i.product_name)}</td>
            <td>${escapeHTML(i.category)}</td>
            <td>${escapeHTML(i.quantity)}</td>
            <td>${formatCurrency(i.cost_price)}</td>
            <td>${formatCurrency(i.selling_price)}</td>
            <td class="text-${status === 'In Stock' ? 'success' : (status === 'Low Stock' ? 'warning' : 'danger')}">${escapeHTML(status)}</td>
            <td>
              <button class="btn btn-outline btn-sm" onclick="editProduct('${i.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteProduct('${i.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No products found</td></tr>';
      }
    }

    function showAddProductModal() {
      document.getElementById('product-id').value = '';
      document.getElementById('product-name').value = '';
      document.getElementById('product-category').value = 'Solar Panels';
      document.getElementById('product-spec').value = '';
      document.getElementById('product-quantity').value = '0';
      document.getElementById('product-cost').value = '';
      document.getElementById('product-selling').value = '';
      document.getElementById('product-supplier').value = '';
      document.getElementById('product-min-level').value = '5';
      showModal('add-product-modal');
    }

    async function saveProduct() {
      const id = document.getElementById('product-id').value;
      const name = document.getElementById('product-name').value.trim();
      const category = document.getElementById('product-category').value;
      const spec = document.getElementById('product-spec').value.trim();
      const qty = parseInt(document.getElementById('product-quantity').value) || 0;
      const cost = parseFloat(document.getElementById('product-cost').value);
      const sell = parseFloat(document.getElementById('product-selling').value);
      const supplier = document.getElementById('product-supplier').value.trim();
      const min = parseInt(document.getElementById('product-min-level').value) || 5;

      if (!name || !category || isNaN(cost) || isNaN(sell)) { 
        showToast('Required fields missing or invalid numbers', 'error'); 
        return; 
      }

      showLoader('Saving...');
      try {
        if (id) {
          const { error } = await supabase.from('inventory').update({
            product_name: name, 
            category, 
            specification: { details: spec }, 
            quantity: qty,
            cost_price: cost, 
            selling_price: sell, 
            supplier_name: supplier || null, 
            min_stock_level: min
          }).eq('id', id);
          if (error) throw error;
          showToast('Product updated', 'success');
        } else {
          const sku = category.substring(0,3).toUpperCase() + '-' + Date.now().toString().slice(-6);
          const { error } = await supabase.from('inventory').insert([{
            sku, 
            product_name: name, 
            category, 
            specification: { details: spec }, 
            quantity: qty,
            cost_price: cost, 
            selling_price: sell, 
            supplier_name: supplier || null, 
            min_stock_level: min,
            created_by: currentUser?.id
          }]);
          if (error) throw error;
          showToast('Product added', 'success');
        }
        closeModal('add-product-modal');
        loadInventory();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function editProduct(id) {
      const p = inventoryItems.find(i => i.id === id);
      if (!p) return;
      document.getElementById('product-id').value = p.id;
      document.getElementById('product-name').value = p.product_name;
      document.getElementById('product-category').value = p.category;
      document.getElementById('product-spec').value = p.specification?.details || '';
      document.getElementById('product-quantity').value = p.quantity;
      document.getElementById('product-cost').value = p.cost_price;
      document.getElementById('product-selling').value = p.selling_price;
      document.getElementById('product-supplier').value = p.supplier_name || '';
      document.getElementById('product-min-level').value = p.min_stock_level || 5;
      showModal('add-product-modal');
    }

    async function deleteProduct(id) {
      if (!confirm('Delete product?')) return;
      showLoader('Deleting...');
      try {
        const { error } = await supabase.from('inventory').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        loadInventory();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== SALES ==========
    async function loadSales() {
      showLoader('Loading sales...');
      try {
        const { data, error } = await supabase
          .from('sales')
          .select('*, customers(name)')
          .order('sale_date', { ascending: false });
        if (error) throw error;
        sales = data || [];
        renderSalesTable(sales);
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function filterSales() {
      const term = document.getElementById('sales-search').value.toLowerCase();
      const service = document.getElementById('sales-service-filter').value;
      const status = document.getElementById('sales-status-filter').value;
      const filtered = sales.filter(s => 
        (s.sale_number?.toLowerCase().includes(term) || s.customers?.name.toLowerCase().includes(term)) &&
        (service === 'all' || s.service_type === service) &&
        (status === 'all' || s.sale_status === status)
      );
      renderSalesTable(filtered);
    }

    function renderSalesTable(items) {
      const tbody = document.getElementById('sales-table-body');
      tbody.innerHTML = '';
      if (items.length) {
        items.forEach(s => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(s.sale_number || '')}</td>
            <td>${escapeHTML(s.customers?.name || '')}</td>
            <td><span class="service-badge service-${escapeHTML(s.service_type?.toLowerCase())}">${escapeHTML(s.service_type)}</span></td>
            <td>${formatCurrency(s.amount)}</td>
            <td>${escapeHTML(formatDate(s.sale_date))}</td>
            <td class="text-${s.payment_status === 'Paid' ? 'success' : 'warning'}">${escapeHTML(s.payment_status)}</td>
            <td>${escapeHTML(s.sale_status)}</td>
            <td>
              <button class="btn btn-outline btn-sm" onclick="editSale('${s.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteSale('${s.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No sales found</td></tr>';
      }
    }

    function showAddSaleModal() {
      showToast('Sales module coming soon', 'info');
    }

    // ========== INSTALLATIONS ==========
    async function loadInstallations() {
      showLoader('Loading installations...');
      try {
        const { data, error } = await supabase
          .from('installations')
          .select('*, customers(name)')
          .order('installation_date', { ascending: false });
        if (error) throw error;
        installations = data || [];
        renderInstallationsTable(installations);
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function filterInstallations() {
      const term = document.getElementById('install-search').value.toLowerCase();
      const status = document.getElementById('install-status-filter').value;
      const filtered = installations.filter(i =>
        (i.customers?.name.toLowerCase().includes(term) || (i.location_address && i.location_address.toLowerCase().includes(term))) &&
        (status === 'all' || i.status === status)
      );
      renderInstallationsTable(filtered);
    }

    function renderInstallationsTable(items) {
      const tbody = document.getElementById('installations-table-body');
      tbody.innerHTML = '';
      if (items.length) {
        items.forEach(i => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(i.id.slice(0,8))}</td>
            <td>${escapeHTML(i.customers?.name || '')}</td>
            <td>${escapeHTML(i.location_address || '')}</td>
            <td>0</td>
            <td>0W</td>
            <td>${escapeHTML(formatDate(i.installation_date))}</td>
            <td class="text-${i.status === 'Completed' ? 'success' : (i.status === 'In Progress' ? 'warning' : 'info')}">${escapeHTML(i.status || 'Scheduled')}</td>
            <td>
              <button class="btn btn-outline btn-sm" onclick="editInstallation('${i.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteInstallation('${i.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No installations found</td></tr>';
      }
    }

    function showAddInstallationModal() {
      showToast('Installations module coming soon', 'info');
    }

    // ========== FINANCIALS ==========
    async function loadFinancials() {
      showLoader('Loading financials...');
      try {
        if (incomeChart) incomeChart.destroy();
        if (profitChart) profitChart.destroy();

        document.getElementById('total-income').innerText = formatCurrency(0);
        document.getElementById('total-expenses').innerText = formatCurrency(0);
        document.getElementById('net-profit').innerText = formatCurrency(0);
        document.getElementById('gross-profit').innerText = formatCurrency(0);

        const tbody = document.getElementById('transactions-table-body');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No transactions found</td></tr>';

        incomeChart = new Chart(document.getElementById('incomeChart'), {
          type: 'bar',
          data: {
            labels: ['No Data'],
            datasets: [{ label: 'Income', data: [0], backgroundColor: '#4caf50' }]
          }
        });

        profitChart = new Chart(document.getElementById('profitChart'), {
          type: 'line',
          data: {
            labels: ['No Data'],
            datasets: [{ label: 'Net Profit', data: [0], borderColor: '#ff9800', fill: false }]
          }
        });
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== SERVICES OVERVIEW ==========
    async function loadServicesOverview() {
      document.getElementById('contracts-count').innerText = '0';
      document.getElementById('consultancy-count').innerText = '0';
      document.getElementById('installations-count').innerText = '0';
      document.getElementById('maintenance-count').innerText = '0';
      document.getElementById('supply-count').innerText = '0';

      const tbody = document.getElementById('services-table-body');
      tbody.innerHTML = '<tr><td colspan="3" class="text-center">No service data</td></tr>';
    }

    // ========== INIT ==========
    (async () => {
      console.log('Initializing app...');
      
      // Check for existing session
      const { data: { session } } = await supabase.auth.getSession();
      console.log('Existing session:', session);
      
      if (session?.user) {
        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', session.user.id)
          .single();
        
        if (profile) {
          currentUser = profile;
          localStorage.setItem('alburuj_user', JSON.stringify(profile));
          document.getElementById('login-page').style.display = 'none';
          document.getElementById('app').style.display = 'block';
          document.getElementById('username-display').textContent = profile.full_name;
          document.getElementById('user-role-display').textContent = profile.role;
          updateDateDisplay();
          applyRoleVisibility(profile.role);
          showModule('dashboard-module');
        }
      }

      // Menu click handlers
      document.querySelectorAll('.sidebar-menu li').forEach(item => {
        item.addEventListener('click', function() {
          document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
          this.classList.add('active');
          const target = this.getAttribute('data-target');
          showModule(target);
        });
      });

      // Close modals on outside click
      window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      };
    })();

    // Expose functions globally
    window.login = login;
    window.logout = logout;
    window.showModule = showModule;
    window.filterCustomers = filterCustomers;
    window.filterInventory = filterInventory;
    window.filterSales = filterSales;
    window.filterInstallations = filterInstallations;
    window.showAddUserModal = showAddUserModal;
    window.showAddCustomerModal = showAddCustomerModal;
    window.saveCustomer = saveCustomer;
    window.editCustomer = editCustomer;
    window.deleteCustomer = deleteCustomer;
    window.showAddProductModal = showAddProductModal;
    window.saveProduct = saveProduct;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.showAddSaleModal = showAddSaleModal;
    window.showAddInstallationModal = showAddInstallationModal;
    window.loadDashboard = loadDashboard;
    window.loadInventory = loadInventory;
    window.loadSales = loadSales;
    window.loadInstallations = loadInstallations;
    window.loadFinancials = loadFinancials;
    window.closeModal = closeModal;
  </script>
</body>
</html>
