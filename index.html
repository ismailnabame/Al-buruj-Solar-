<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Al Buruj Solar • Business Portal</title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ========== RESET & VARIABLES ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    :root {
      --primary: #0d7eb8;
      --secondary: #4fc3f7;
      --accent: #29b6f6;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --light: #e3f2fd;
      --dark: #1565c0;
      --gray: #78909c;
      --card-shadow: 0 8px 25px rgba(13, 126, 184, 0.1);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    body {
      background: #f5f7fa;
      color: #333;
    }
    /* ========== LOADER ========== */
    #global-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      pointer-events: all; /* blocks interactions */
    }
    .loader-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #e3f2fd;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    .loader-text { color: var(--primary); font-weight: 500; }

    /* ========== TOAST ========== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9998;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }
    .toast-success { background: var(--success); }
    .toast-error { background: var(--danger); }
    .toast-warning { background: var(--warning); }
    .toast-info { background: var(--secondary); }
    .toast-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
      opacity: 0.8;
    }

    /* ========== LOGIN PAGE ========== */
    #login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 50%, #0288d1 100%);
    }
    .login-container {
      background: #fff;
      padding: 40px;
      border-radius: 15px;
      box-shadow: var(--card-shadow);
      width: 100%;
      max-width: 450px;
      text-align: center;
    }
    .logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 20px;
      background: url('https://i.postimg.cc/MTJn43gD/Screenshot-20260127-214753.jpg') center/contain no-repeat;
    }
    .login-container h1 { color: var(--primary); margin-bottom: 10px; }
    .login-container p { color: var(--gray); margin-bottom: 30px; }
    .form-group { margin-bottom: 20px; text-align: left; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: var(--transition);
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13,126,184,0.2);
    }
    .login-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    .login-btn:hover {
      background: #0a6da5;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .error-message { color: var(--danger); margin-top: 15px; display: none; }

    /* ========== MAIN APP LAYOUT ========== */
    #app { display: none; min-height: 100vh; }
    header {
      background: #fff;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 3px solid var(--primary);
    }
    .header-left { display: flex; align-items: center; }
    .header-logo {
      width: 50px;
      height: 50px;
      margin-right: 15px;
      background: url('https://i.postimg.cc/MTJn43gD/Screenshot-20260127-214753.jpg') center/contain no-repeat;
    }
    header h1 { color: var(--primary); font-size: 20px; font-weight: 600; }
    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
      color: #555;
    }
    .user-info span { font-weight: 500; }
    .logout-btn {
      background: var(--danger);
      color: #fff;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }
    .logout-btn:hover { background: #d32f2f; transform: translateY(-2px); }

    /* ========== SIDEBAR ========== */
    .sidebar {
      width: 280px;
      background: #fff;
      height: calc(100vh - 70px);
      position: fixed;
      left: 0;
      top: 70px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      overflow-y: auto;
      border-right: 2px solid #e3f2fd;
    }
    .sidebar-menu {
      list-style: none;
      padding: 20px 0;
    }
    .sidebar-menu li {
      padding: 12px 25px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #444;
      transition: var(--transition);
      border-left: 4px solid transparent;
      margin: 5px 0;
    }
    .sidebar-menu li i { width: 20px; text-align: center; color: var(--primary); }
    .sidebar-menu li:hover {
      background: rgba(13,126,184,0.05);
      border-left: 4px solid var(--accent);
      color: var(--primary);
    }
    .sidebar-menu li.active {
      background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);
      color: var(--primary);
      font-weight: 600;
      border-left: 4px solid var(--primary);
    }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      margin-left: 280px;
      padding: 30px;
      min-height: calc(100vh - 70px);
    }
    .module-section { display: none; animation: fadeIn 0.5s ease; }
    .module-section.active { display: block; }

    /* ========== CARDS & TABLES ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      border-top: 4px solid var(--primary);
    }
    .stat-card h3 { font-size: 14px; color: var(--gray); margin-bottom: 10px; }
    .stat-card .value { font-size: 28px; font-weight: 600; color: var(--primary); }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      padding: 25px;
      margin-bottom: 30px;
      overflow-x: auto;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .card-header h3 { color: var(--primary); font-size: 18px; }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--primary);
    }
    tr:hover { background: rgba(13,126,184,0.03); }

    /* Status colors */
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-danger { color: var(--danger); }
    .text-info { color: var(--secondary); }

    /* ========== BUTTONS ========== */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      font-weight: 500;
      font-size: 14px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #0a6da5; transform: translateY(-2px); }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    .btn-outline:hover { background: var(--primary); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { background: #d32f2f; }
    .btn-success { background: var(--success); color: #fff; }

    /* ========== FILTERS ========== */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }
    .filters input, .filters select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      min-width: 200px;
    }

    /* ========== MODALS ========== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-content {
      background: #fff;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);
    }
    .modal-header h2 { color: var(--primary); margin: 0; }
    .close-modal {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #555;
    }
    .close-modal:hover { color: var(--danger); }
    .modal-body { padding: 20px; }
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-row .form-group { flex: 1; margin-bottom: 0; }
    .form-actions {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: #f8f9fa;
    }

    /* ========== SERVICE BADGES ========== */
    .service-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .service-contract { background: #e8f5e9; color: #2e7d32; }
    .service-consultancy { background: #e3f2fd; color: #1565c0; }
    .service-installation { background: #fff3e0; color: #ef6c00; }
    .service-maintenance { background: #f3e5f5; color: #7b1fa2; }
    .service-supply { background: #e0f2f1; color: #00695c; }

    /* ========== ANIMATIONS ========== */
    @keyframes spin { 100% { transform: rotate(360deg); } }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="global-loader">
    <div class="loader-spinner"></div>
    <div class="loader-text">Loading...</div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Login Page -->
  <div id="login-page">
    <div class="login-container">
      <div class="logo"></div>
      <h1>Al Buruj Solar</h1>
      <p>Business Management System</p>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="Enter your email">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" placeholder="Enter your password">
      </div>
      <div class="form-group">
        <label>Role</label>
        <select id="role-select">
          <option value="">Select Role</option>
          <option value="Admin">Admin</option>
          <option value="Sales">Sales</option>
          <option value="Inventory">Inventory</option>
        </select>
      </div>
      <button class="login-btn" onclick="login()">Login</button>
      <div id="login-error" class="error-message"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="app">
    <header>
      <div class="header-left">
        <div class="header-logo"></div>
        <h1>Al Buruj Solar Business Portal</h1>
      </div>
      <div class="user-info">
        <span id="date-display"></span>
        <span id="user-role-display"></span>
        <span id="username-display"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar">
      <ul class="sidebar-menu">
        <li data-target="dashboard-module" class="menu-item"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
        <li data-target="admin-module" class="menu-item admin-only"><i class="fas fa-user-shield"></i> Admin Panel</li>
        <li data-target="customers-module" class="menu-item sales-only admin-only"><i class="fas fa-users"></i> Customers</li>
        <li data-target="inventory-module" class="menu-item inventory-only admin-only"><i class="fas fa-boxes"></i> Inventory</li>
        <li data-target="sales-module" class="menu-item sales-only admin-only"><i class="fas fa-shopping-cart"></i> Sales</li>
        <li data-target="installations-module" class="menu-item sales-only admin-only inventory-only"><i class="fas fa-solar-panel"></i> Installations</li>
        <li data-target="financial-module" class="menu-item admin-only"><i class="fas fa-file-invoice-dollar"></i> Financials</li>
        <li data-target="services-module" class="menu-item admin-only sales-only"><i class="fas fa-concierge-bell"></i> Services Overview</li>
      </ul>
    </div>

    <div class="main-content">
      <!-- Dashboard Module -->
      <div id="dashboard-module" class="module-section">
        <div class="section-header">
          <h2>Dashboard</h2>
          <button class="btn btn-outline" onclick="loadDashboard()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Sales (Month)</h3><div class="value" id="total-sales-month">₦0</div></div>
          <div class="stat-card"><h3>Active Projects</h3><div class="value" id="active-projects">0</div></div>
          <div class="stat-card"><h3>Low Stock Items</h3><div class="value" id="low-stock-count">0</div></div>
          <div class="stat-card"><h3>Total Customers</h3><div class="value" id="total-customers">0</div></div>
        </div>
        <div class="row" style="display: flex; gap: 20px;">
          <div style="flex:1; background: #fff; padding: 20px; border-radius: 10px;">
            <h3>Service Distribution</h3>
            <canvas id="serviceChart"></canvas>
          </div>
          <div style="flex:1; background: #fff; padding: 20px; border-radius: 10px;">
            <h3>Monthly Sales</h3>
            <canvas id="salesChart"></canvas>
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-header"><h3>Recent Sales</h3></div>
          <table>
            <thead><tr><th>Sale #</th><th>Customer</th><th>Service</th><th>Amount</th><th>Date</th><th>Status</th></tr></thead>
            <tbody id="recent-sales-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Admin Module (User Management) -->
      <div id="admin-module" class="module-section">
        <div class="section-header">
          <h2>Admin Panel</h2>
          <button class="btn btn-primary" onclick="showAddUserModal()"><i class="fas fa-user-plus"></i> Add User</button>
        </div>
        <div class="card">
          <div class="card-header"><h3>Users</h3></div>
          <table>
            <thead><tr><th>Username</th><th>Full Name</th><th>Role</th><th>Email</th><th>Last Login</th><th>Actions</th></tr></thead>
            <tbody id="users-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Customers Module -->
      <div id="customers-module" class="module-section">
        <div class="section-header">
          <h2>Customers</h2>
          <button class="btn btn-primary" onclick="showAddCustomerModal()"><i class="fas fa-user-plus"></i> Add Customer</button>
        </div>
        <div class="filters">
          <input type="text" id="customer-search" placeholder="Search customers..." onkeyup="filterCustomers()">
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Code</th><th>Name</th><th>Email</th><th>Phone</th><th>Type</th><th>Actions</th></tr></thead>
            <tbody id="customers-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Inventory Module -->
      <div id="inventory-module" class="module-section">
        <div class="section-header">
          <h2>Inventory</h2>
          <button class="btn btn-primary" onclick="showAddProductModal()"><i class="fas fa-plus"></i> Add Product</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Products</h3><div class="value" id="total-products">0</div></div>
          <div class="stat-card"><h3>Inventory Value</h3><div class="value" id="inventory-value">₦0</div></div>
          <div class="stat-card"><h3>Low Stock</h3><div class="value" id="low-stock-inventory">0</div></div>
        </div>
        <div class="filters">
          <input type="text" id="inventory-search" placeholder="Search products..." onkeyup="filterInventory()">
          <select id="inventory-category" onchange="filterInventory()">
            <option value="all">All Categories</option>
            <option value="Solar Panels">Solar Panels</option>
            <option value="Batteries">Batteries</option>
            <option value="Inverters">Inverters</option>
            <option value="Charge Controllers">Charge Controllers</option>
            <option value="Cables">Cables</option>
            <option value="Accessories">Accessories</option>
          </select>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>SKU</th><th>Product</th><th>Category</th><th>Qty</th><th>Cost</th><th>Selling</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="inventory-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Sales Module -->
      <div id="sales-module" class="module-section">
        <div class="section-header">
          <h2>Sales</h2>
          <button class="btn btn-primary" onclick="showAddSaleModal()"><i class="fas fa-plus"></i> New Sale</button>
        </div>
        <div class="filters">
          <input type="text" id="sales-search" placeholder="Search sales..." onkeyup="filterSales()">
          <select id="sales-service-filter" onchange="filterSales()">
            <option value="all">All Services</option>
            <option value="Contract">Contract</option>
            <option value="Consultancy">Consultancy</option>
            <option value="Installation">Installation</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Supply">Supply</option>
          </select>
          <select id="sales-status-filter" onchange="filterSales()">
            <option value="all">All Status</option>
            <option value="Draft">Draft</option>
            <option value="Confirmed">Confirmed</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Sale #</th><th>Customer</th><th>Service</th><th>Amount</th><th>Date</th><th>Payment</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="sales-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Installations Module -->
      <div id="installations-module" class="module-section">
        <div class="section-header">
          <h2>Installations</h2>
          <button class="btn btn-primary" onclick="showAddInstallationModal()"><i class="fas fa-plus"></i> Add Installation</button>
        </div>
        <div class="filters">
          <input type="text" id="install-search" placeholder="Search..." onkeyup="filterInstallations()">
          <select id="install-status-filter" onchange="filterInstallations()">
            <option value="all">All Status</option>
            <option value="Scheduled">Scheduled</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Project ID</th><th>Customer</th><th>Location</th><th>Panels</th><th>Total Watts</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="installations-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Financial Module -->
      <div id="financial-module" class="module-section">
        <div class="section-header">
          <h2>Financial Overview</h2>
          <button class="btn btn-success" onclick="loadFinancials()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Income</h3><div class="value" id="total-income">₦0</div></div>
          <div class="stat-card"><h3>Total Expenses</h3><div class="value" id="total-expenses">₦0</div></div>
          <div class="stat-card"><h3>Net Profit</h3><div class="value" id="net-profit">₦0</div></div>
          <div class="stat-card"><h3>Gross Profit</h3><div class="value" id="gross-profit">₦0</div></div>
        </div>
        <div class="row" style="display: flex; gap: 20px;">
          <div style="flex:1; background: #fff; padding: 20px; border-radius: 10px;">
            <h3>Income by Service</h3>
            <canvas id="incomeChart"></canvas>
          </div>
          <div style="flex:1; background: #fff; padding: 20px; border-radius: 10px;">
            <h3>Monthly Profit Trend</h3>
            <canvas id="profitChart"></canvas>
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-header"><h3>Recent Transactions</h3></div>
          <table>
            <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th></tr></thead>
            <tbody id="transactions-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Services Overview Module -->
      <div id="services-module" class="module-section">
        <div class="section-header"><h2>Services Overview</h2></div>
        <div class="stats-grid">
          <div class="stat-card"><h3>Contracts</h3><div class="value" id="contracts-count">0</div></div>
          <div class="stat-card"><h3>Consultancy</h3><div class="value" id="consultancy-count">0</div></div>
          <div class="stat-card"><h3>Installations</h3><div class="value" id="installations-count">0</div></div>
          <div class="stat-card"><h3>Maintenance</h3><div class="value" id="maintenance-count">0</div></div>
          <div class="stat-card"><h3>Supply</h3><div class="value" id="supply-count">0</div></div>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Service</th><th>Total Sales</th><th>Revenue</th></tr></thead>
            <tbody id="services-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== MODALS ========== -->
  <!-- Add User Modal -->
  <div id="add-user-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Add User</h2><button class="close-modal" onclick="closeModal('add-user-modal')">&times;</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label>Username</label><input id="user-username"></div>
          <div class="form-group"><label>Full Name</label><input id="user-fullname"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Email</label><input type="email" id="user-email"></div>
          <div class="form-group"><label>Password</label><input type="password" id="user-password"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Role</label>
            <select id="user-role">
              <option value="Admin">Admin</option>
              <option value="Sales">Sales</option>
              <option value="Inventory">Inventory</option>
            </select>
          </div>
          <div class="form-group"><label>Phone</label><input id="user-phone"></div>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeModal('add-user-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveUser()">Save</button>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div id="add-customer-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Add Customer</h2><button class="close-modal" onclick="closeModal('add-customer-modal')">&times;</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label>Name*</label><input id="customer-name"></div>
          <div class="form-group"><label>Email</label><input type="email" id="customer-email"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Phone</label><input id="customer-phone"></div>
          <div class="form-group"><label>Type</label>
            <select id="customer-type">
              <option value="Individual">Individual</option>
              <option value="Business">Business</option>
              <option value="Government">Government</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Address</label><input id="customer-address"></div>
          <div class="form-group"><label>City</label><input id="customer-city"></div>
        </div>
        <input type="hidden" id="customer-id">
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeModal('add-customer-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCustomer()">Save</button>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="add-product-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Add Product</h2><button class="close-modal" onclick="closeModal('add-product-modal')">&times;</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label>Product Name*</label><input id="product-name"></div>
          <div class="form-group"><label>Category*</label>
            <select id="product-category">
              <option value="Solar Panels">Solar Panels</option>
              <option value="Batteries">Batteries</option>
              <option value="Inverters">Inverters</option>
              <option value="Charge Controllers">Charge Controllers</option>
              <option value="Cables">Cables</option>
              <option value="Accessories">Accessories</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Specification</label><input id="product-spec"></div>
          <div class="form-group"><label>Quantity*</label><input type="number" id="product-quantity" value="0"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Cost Price (₦)*</label><input type="number" id="product-cost"></div>
          <div class="form-group"><label>Selling Price (₦)*</label><input type="number" id="product-selling"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Supplier Name</label><input id="product-supplier"></div>
          <div class="form-group"><label>Min Stock Level</label><input type="number" id="product-min-level" value="5"></div>
        </div>
        <input type="hidden" id="product-id">
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeModal('add-product-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveProduct()">Save</button>
      </div>
    </div>
  </div>

  <!-- Add Sale Modal -->
  <div id="add-sale-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>New Sale</h2><button class="close-modal" onclick="closeModal('add-sale-modal')">&times;</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label>Customer*</label>
            <select id="sale-customer-id" required></select>
          </div>
          <div class="form-group"><label>Service Type*</label>
            <select id="sale-service-type" onchange="toggleInstallationFields()">
              <option value="Supply">Supply</option>
              <option value="Installation">Installation</option>
              <option value="Consultancy">Consultancy</option>
              <option value="Maintenance">Maintenance</option>
              <option value="Contract">Contract</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Amount (₦)*</label><input type="number" id="sale-amount"></div>
          <div class="form-group"><label>Payment Status</label>
            <select id="sale-payment-status">
              <option value="Pending">Pending</option>
              <option value="Partial">Partial</option>
              <option value="Paid">Paid</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Sale Status</label>
            <select id="sale-status">
              <option value="Draft">Draft</option>
              <option value="Confirmed">Confirmed</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          </div>
          <div class="form-group"><label>Due Date</label><input type="date" id="sale-due-date"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Notes</label><input id="sale-notes"></div>
        </div>
        <input type="hidden" id="sale-id">
        <input type="hidden" id="existing-installation-id">

        <!-- Installation Fields (shown only when Installation is selected) -->
        <div id="installation-fields" style="display: none; border-top: 1px solid #ddd; margin-top: 15px; padding-top: 15px;">
          <h4>Installation Details</h4>
          <div class="form-row">
            <div class="form-group"><label>Location</label><input id="install-location"></div>
            <div class="form-group"><label>Install Date</label><input type="date" id="install-date"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Latitude</label><input id="install-lat"></div>
            <div class="form-group"><label>Longitude</label><input id="install-lng"></div>
          </div>
          <h5>Panels</h5>
          <div id="panels-container" class="dynamic-fields-container"></div>
          <button type="button" class="btn btn-outline" onclick="addPanelField('panels-container')">Add Panel</button>
          <h5 style="margin-top: 15px;">Expenses</h5>
          <div id="expenses-container" class="dynamic-fields-container"></div>
          <button type="button" class="btn btn-outline" onclick="addExpenseField('expenses-container')">Add Expense</button>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeModal('add-sale-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveSale()">Save Sale</button>
      </div>
    </div>
  </div>

  <!-- Add Installation Modal -->
  <div id="add-installation-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Add Installation</h2><button class="close-modal" onclick="closeModal('add-installation-modal')">&times;</button></div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label>Sale*</label>
            <select id="install-sale-id" required></select>
          </div>
          <div class="form-group"><label>Customer*</label>
            <select id="install-customer-id" required></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Location*</label><input id="install-modal-location"></div>
          <div class="form-group"><label>Install Date</label><input type="date" id="install-modal-date"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Latitude</label><input id="install-modal-lat"></div>
          <div class="form-group"><label>Longitude</label><input id="install-modal-lng"></div>
        </div>
        <h5>Panels</h5>
        <div id="install-panels-container" class="dynamic-fields-container"></div>
        <button type="button" class="btn btn-outline" onclick="addPanelField('install-panels-container', 'install-panel')">Add Panel</button>
        <h5 style="margin-top: 15px;">Expenses</h5>
        <div id="install-expenses-container" class="dynamic-fields-container"></div>
        <button type="button" class="btn btn-outline" onclick="addExpenseField('install-expenses-container', 'install-expense')">Add Expense</button>
        <input type="hidden" id="install-id">
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeModal('add-installation-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveInstallation()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ========== SUPABASE INITIALIZATION ==========
    // Replace with your actual Supabase URL and anon key
    const SUPABASE_URL = 'https://cstzpeannerdvwyxpfph.supabase.co';
    const SUPABASE_ANON_KEY =  'sb_publishable_SEiYbtYlFn8YShWyPa_vSQ_ZF_-yiym';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global state
    let currentUser = null;
    let customers = [];
    let inventoryItems = [];
    let sales = [];
    let installations = [];
    let users = [];

    // Chart instances
    let serviceChart, salesChart, incomeChart, profitChart;

    // ========== UTILITY FUNCTIONS ==========
    function showLoader(message = 'Loading...') {
      document.getElementById('global-loader').style.display = 'flex';
      document.querySelector('.loader-text').textContent = message;
    }
    function hideLoader() {
      document.getElementById('global-loader').style.display = 'none';
    }
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      const msgSpan = document.createElement('span');
      msgSpan.className = 'toast-message';
      msgSpan.textContent = message;  // safe from XSS
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'toast-close';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = function() { toast.remove(); };
      
      toast.appendChild(msgSpan);
      toast.appendChild(closeBtn);
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }
    function escapeHTML(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"]/g, function(m) {
        return { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[m];
      });
    }
    function formatCurrency(amount) {
      return '₦' + Number(amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      return new Date(dateStr).toLocaleDateString('en-NG', { day: '2-digit', month: 'short', year: 'numeric' });
    }
    function formatDateTime(dateStr) {
      if (!dateStr) return 'N/A';
      return new Date(dateStr).toLocaleString('en-NG');
    }
    function showModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    // Close modal when clicking outside content
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal(this.id);
      });
    });

    // ========== AUTHENTICATION ==========
    async function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('role-select').value;

      if (!email || !password || !role) {
        showToast('All fields are required', 'error');
        return;
      }

      showLoader('Authenticating...');
      try {
        const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });
        if (authError) throw authError;

        // Fetch profile
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', authData.user.id)
          .single();
        if (profileError) throw profileError;

        if (profile.role !== role) {
          throw new Error('Role mismatch. Please select the correct role.');
        }

        currentUser = profile;
        localStorage.setItem('alburuj_user', JSON.stringify(profile));

        // Update last login
        await supabase.from('profiles').update({ last_login: new Date().toISOString() }).eq('id', profile.id);

        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('username-display').textContent = profile.full_name;
        document.getElementById('user-role-display').textContent = profile.role;
        updateDateDisplay();
        applyRoleVisibility(profile.role);

        // Load default module
        showModule('dashboard-module');
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      localStorage.removeItem('alburuj_user');
      location.reload();
    }

    function updateDateDisplay() {
      const now = new Date();
      document.getElementById('date-display').textContent = now.toLocaleDateString('en-NG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    function applyRoleVisibility(role) {
      document.querySelectorAll('.menu-item').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.menu-item').forEach(el => {
        if (el.classList.contains(role.toLowerCase() + '-only') || (role === 'Admin' && el.classList.contains('admin-only'))) {
          el.style.display = 'flex';
        }
      });
      // Admin sees all
      if (role === 'Admin') {
        document.querySelectorAll('.menu-item').forEach(el => el.style.display = 'flex');
      }
    }

    function showModule(moduleId) {
      document.querySelectorAll('.module-section').forEach(m => m.classList.remove('active'));
      document.getElementById(moduleId).classList.add('active');

      // Load data based on module
      if (moduleId === 'dashboard-module') loadDashboard();
      else if (moduleId === 'admin-module') loadUsers();
      else if (moduleId === 'customers-module') loadCustomers();
      else if (moduleId === 'inventory-module') loadInventory();
      else if (moduleId === 'sales-module') loadSales();
      else if (moduleId === 'installations-module') loadInstallations();
      else if (moduleId === 'financial-module') loadFinancials();
      else if (moduleId === 'services-module') loadServicesOverview();
    }

    // ========== DASHBOARD ==========
    async function loadDashboard() {
      showLoader('Loading dashboard...');
      try {
        if (serviceChart) serviceChart.destroy();
        if (salesChart) salesChart.destroy();

        // Stats (assuming RPC exists)
        const { data: stats, error: statsError } = await supabase.rpc('get_dashboard_stats');
        if (!statsError && stats) {
          document.getElementById('total-sales-month').innerText = formatCurrency(stats.total_sales_month);
          document.getElementById('active-projects').innerText = stats.active_projects || 0;
          document.getElementById('low-stock-count').innerText = stats.low_stock_count || 0;
          document.getElementById('total-customers').innerText = stats.total_customers || 0;
        }

        // Recent sales
        const { data: recentSales, error: salesError } = await supabase
          .from('sales')
          .select('*, customers(name)')
          .order('sale_date', { ascending: false })
          .limit(5);
        if (!salesError) {
          const tbody = document.getElementById('recent-sales-body');
          tbody.innerHTML = '';
          if (recentSales && recentSales.length) {
            recentSales.forEach(sale => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${escapeHTML(sale.sale_number || 'N/A')}</td>
                <td>${escapeHTML(sale.customers?.name || 'N/A')}</td>
                <td><span class="service-badge service-${escapeHTML(sale.service_type?.toLowerCase())}">${escapeHTML(sale.service_type)}</span></td>
                <td>${formatCurrency(sale.amount)}</td>
                <td>${escapeHTML(formatDate(sale.sale_date))}</td>
                <td class="text-${sale.payment_status === 'Paid' ? 'success' : 'warning'}">${escapeHTML(sale.payment_status)}</td>
              `;
              tbody.appendChild(row);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No recent sales</td></tr>';
          }
        }

        // Service distribution chart
        const { data: salesData } = await supabase.from('sales').select('service_type');
        const counts = {};
        (salesData || []).forEach(s => counts[s.service_type] = (counts[s.service_type] || 0) + 1);
        serviceChart = new Chart(document.getElementById('serviceChart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(counts),
            datasets: [{ data: Object.values(counts), backgroundColor: ['#4caf50','#2196f3','#ff9800','#9c27b0','#00bcd4'] }]
          }
        });

        // Monthly sales chart
        const { data: monthly } = await supabase.rpc('get_sales_chart_data', { period_type: 'month' });
        if (monthly) {
          salesChart = new Chart(document.getElementById('salesChart'), {
            type: 'line',
            data: {
              labels: monthly.map(d => d.date),
              datasets: [{ label: 'Sales (₦)', data: monthly.map(d => d.total), borderColor: '#2196f3', fill: false }]
            }
          });
        }
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== ADMIN: USER MANAGEMENT ==========
    async function loadUsers() {
      showLoader('Loading users...');
      try {
        const { data, error } = await supabase.from('profiles').select('*').order('created_at');
        if (error) throw error;
        users = data || [];
        const tbody = document.getElementById('users-table-body');
        tbody.innerHTML = '';
        if (users.length) {
          users.forEach(u => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${escapeHTML(u.username || '')}</td>
              <td>${escapeHTML(u.full_name)}</td>
              <td>${escapeHTML(u.role)}</td>
              <td>${escapeHTML(u.email)}</td>
              <td>${escapeHTML(u.last_login ? formatDateTime(u.last_login) : 'Never')}</td>
              <td>
                <button class="btn btn-outline btn-sm" onclick="editUser('${u.id}')">Edit</button>
                ${u.id !== currentUser.id ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Delete</button>` : ''}
              </td>
            `;
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found</td></tr>';
        }
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function showAddUserModal() {
      showToast('User creation requires a backend function. Use Supabase dashboard.', 'warning');
    }

    // ========== CUSTOMERS ==========
    async function loadCustomers() {
      showLoader('Loading customers...');
      try {
        const { data, error } = await supabase.from('customers').select('*').order('name');
        if (error) throw error;
        customers = data || [];
        renderCustomersTable(customers);
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function filterCustomers() {
      const term = document.getElementById('customer-search').value.toLowerCase();
      const filtered = customers.filter(c => 
        c.name.toLowerCase().includes(term) || (c.email && c.email.toLowerCase().includes(term))
      );
      renderCustomersTable(filtered);
    }

    function renderCustomersTable(custs) {
      const tbody = document.getElementById('customers-table-body');
      tbody.innerHTML = '';
      if (custs.length) {
        custs.forEach(c => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(c.customer_code || '')}</td>
            <td>${escapeHTML(c.name)}</td>
            <td>${escapeHTML(c.email || '')}</td>
            <td>${escapeHTML(c.phone || '')}</td>
            <td>${escapeHTML(c.customer_type || '')}</td>
            <td>
              <button class="btn btn-outline btn-sm" onclick="editCustomer('${c.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${c.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No customers found</td></tr>';
      }
    }

    function showAddCustomerModal() {
      document.getElementById('customer-id').value = '';
      document.getElementById('customer-name').value = '';
      document.getElementById('customer-email').value = '';
      document.getElementById('customer-phone').value = '';
      document.getElementById('customer-type').value = 'Individual';
      document.getElementById('customer-address').value = '';
      document.getElementById('customer-city').value = '';
      showModal('add-customer-modal');
    }

    async function saveCustomer() {
      const id = document.getElementById('customer-id').value;
      const name = document.getElementById('customer-name').value.trim();
      const email = document.getElementById('customer-email').value.trim();
      const phone = document.getElementById('customer-phone').value.trim();
      const type = document.getElementById('customer-type').value;
      const address = document.getElementById('customer-address').value.trim();
      const city = document.getElementById('customer-city').value.trim();

      if (!name) { showToast('Name is required', 'error'); return; }

      showLoader('Saving...');
      try {
        if (id) {
          const { error } = await supabase.from('customers').update({ name, email, phone, customer_type: type, address, city }).eq('id', id);
          if (error) throw error;
          showToast('Customer updated', 'success');
        } else {
          const { data: code, error: codeError } = await supabase.rpc('generate_customer_code');
          if (codeError) throw codeError;
          const { error } = await supabase.from('customers').insert([{
            customer_code: code,
            name, email, phone, customer_type: type, address, city,
            created_by: currentUser.id
          }]);
          if (error) throw error;
          showToast('Customer added', 'success');
        }
        closeModal('add-customer-modal');
        loadCustomers();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function editCustomer(id) {
      const cust = customers.find(c => c.id === id);
      if (!cust) return;
      document.getElementById('customer-id').value = cust.id;
      document.getElementById('customer-name').value = cust.name;
      document.getElementById('customer-email').value = cust.email || '';
      document.getElementById('customer-phone').value = cust.phone || '';
      document.getElementById('customer-type').value = cust.customer_type || 'Individual';
      document.getElementById('customer-address').value = cust.address || '';
      document.getElementById('customer-city').value = cust.city || '';
      showModal('add-customer-modal');
    }

    async function deleteCustomer(id) {
      if (!confirm('Delete customer?')) return;
      showLoader('Deleting...');
      try {
        const { error } = await supabase.from('customers').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        loadCustomers();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== INVENTORY ==========
    async function loadInventory() {
      showLoader('Loading inventory...');
      try {
        const { data, error } = await supabase.from('inventory').select('*').order('product_name');
        if (error) throw error;
        inventoryItems = data || [];
        const { data: stats, error: statsError } = await supabase.rpc('get_inventory_stats');
        if (!statsError && stats) {
          document.getElementById('total-products').innerText = stats.total_products || 0;
          document.getElementById('inventory-value').innerText = formatCurrency(stats.total_value);
          document.getElementById('low-stock-inventory').innerText = stats.low_stock_count || 0;
        }
        renderInventoryTable(inventoryItems);
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function filterInventory() {
      const term = document.getElementById('inventory-search').value.toLowerCase();
      const cat = document.getElementById('inventory-category').value;
      const filtered = inventoryItems.filter(i => 
        (i.product_name.toLowerCase().includes(term) || (i.sku && i.sku.toLowerCase().includes(term))) &&
        (cat === 'all' || i.category === cat)
      );
      renderInventoryTable(filtered);
    }

    function renderInventoryTable(items) {
      const tbody = document.getElementById('inventory-table-body');
      tbody.innerHTML = '';
      if (items.length) {
        items.forEach(i => {
          const status = i.quantity === 0 ? 'Out of Stock' : (i.quantity <= i.min_stock_level ? 'Low Stock' : 'In Stock');
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(i.sku || '')}</td>
            <td>${escapeHTML(i.product_name)}</td>
            <td>${escapeHTML(i.category)}</td>
            <td>${escapeHTML(i.quantity)}</td>
            <td>${formatCurrency(i.cost_price)}</td>
            <td>${formatCurrency(i.selling_price)}</td>
            <td class="text-${status === 'In Stock' ? 'success' : (status === 'Low Stock' ? 'warning' : 'danger')}">${escapeHTML(status)}</td>
            <td>
              <button class="btn btn-outline btn-sm" onclick="editProduct('${i.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteProduct('${i.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No products found</td></tr>';
      }
    }

    function showAddProductModal() {
      document.getElementById('product-id').value = '';
      document.getElementById('product-name').value = '';
      document.getElementById('product-category').value = 'Solar Panels';
      document.getElementById('product-spec').value = '';
      document.getElementById('product-quantity').value = '0';
      document.getElementById('product-cost').value = '';
      document.getElementById('product-selling').value = '';
      document.getElementById('product-supplier').value = '';
      document.getElementById('product-min-level').value = '5';
      showModal('add-product-modal');
    }

    async function saveProduct() {
      const id = document.getElementById('product-id').value;
      const name = document.getElementById('product-name').value.trim();
      const category = document.getElementById('product-category').value;
      const spec = document.getElementById('product-spec').value.trim();
      const qty = parseInt(document.getElementById('product-quantity').value) || 0;
      const cost = parseFloat(document.getElementById('product-cost').value);
      const sell = parseFloat(document.getElementById('product-selling').value);
      const supplier = document.getElementById('product-supplier').value.trim(); // now stored as supplier_name
      const min = parseInt(document.getElementById('product-min-level').value) || 5;

      if (!name || !category || isNaN(cost) || isNaN(sell)) { 
        showToast('Required fields missing or invalid numbers', 'error'); 
        return; 
      }

      showLoader('Saving...');
      try {
        if (id) {
          const { error } = await supabase.from('inventory').update({
            product_name: name, category, specification: { details: spec }, quantity: qty,
            cost_price: cost, selling_price: sell, supplier_name: supplier || null, min_stock_level: min
          }).eq('id', id);
          if (error) throw error;
          showToast('Product updated', 'success');
        } else {
          const sku = category.substring(0,3).toUpperCase() + '-' + Date.now().toString().slice(-6);
          const { error } = await supabase.from('inventory').insert([{
            sku, product_name: name, category, specification: { details: spec }, quantity: qty,
            cost_price: cost, selling_price: sell, supplier_name: supplier || null, min_stock_level: min,
            created_by: currentUser.id
          }]);
          if (error) throw error;
          showToast('Product added', 'success');
        }
        closeModal('add-product-modal');
        loadInventory();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function editProduct(id) {
      const p = inventoryItems.find(i => i.id === id);
      if (!p) return;
      document.getElementById('product-id').value = p.id;
      document.getElementById('product-name').value = p.product_name;
      document.getElementById('product-category').value = p.category;
      document.getElementById('product-spec').value = p.specification?.details || '';
      document.getElementById('product-quantity').value = p.quantity;
      document.getElementById('product-cost').value = p.cost_price;
      document.getElementById('product-selling').value = p.selling_price;
      document.getElementById('product-supplier').value = p.supplier_name || '';
      document.getElementById('product-min-level').value = p.min_stock_level;
      showModal('add-product-modal');
    }

    async function deleteProduct(id) {
      if (!confirm('Delete product?')) return;
      showLoader('Deleting...');
      try {
        const { error } = await supabase.from('inventory').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        loadInventory();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== SALES ==========
    async function loadSales() {
      showLoader('Loading sales...');
      try {
        const { data, error } = await supabase
          .from('sales')
          .select('*, customers(name)')
          .order('sale_date', { ascending: false });
        if (error) throw error;
        sales = data || [];
        renderSalesTable(sales);
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function filterSales() {
      const term = document.getElementById('sales-search').value.toLowerCase();
      const service = document.getElementById('sales-service-filter').value;
      const status = document.getElementById('sales-status-filter').value;
      const filtered = sales.filter(s => 
        (s.sale_number?.toLowerCase().includes(term) || s.customers?.name.toLowerCase().includes(term)) &&
        (service === 'all' || s.service_type === service) &&
        (status === 'all' || s.sale_status === status)
      );
      renderSalesTable(filtered);
    }

    function renderSalesTable(items) {
      const tbody = document.getElementById('sales-table-body');
      tbody.innerHTML = '';
      if (items.length) {
        items.forEach(s => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(s.sale_number || '')}</td>
            <td>${escapeHTML(s.customers?.name || '')}</td>
            <td><span class="service-badge service-${escapeHTML(s.service_type?.toLowerCase())}">${escapeHTML(s.service_type)}</span></td>
            <td>${formatCurrency(s.amount)}</td>
            <td>${escapeHTML(formatDate(s.sale_date))}</td>
            <td class="text-${s.payment_status === 'Paid' ? 'success' : 'warning'}">${escapeHTML(s.payment_status)}</td>
            <td>${escapeHTML(s.sale_status)}</td>
            <td>
              <button class="btn btn-outline btn-sm" onclick="editSale('${s.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteSale('${s.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No sales found</td></tr>';
      }
    }

    async function showAddSaleModal() {
      // Populate customer dropdown
      const { data: custs, error } = await supabase.from('customers').select('id,name').order('name');
      if (error) { showToast(error.message, 'error'); return; }
      const select = document.getElementById('sale-customer-id');
      select.innerHTML = '<option value="">Select Customer</option>';
      custs.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        select.appendChild(opt);
      });

      // Reset form
      document.getElementById('sale-id').value = '';
      document.getElementById('existing-installation-id').value = '';
      document.getElementById('sale-customer-id').value = '';
      document.getElementById('sale-service-type').value = 'Supply';
      document.getElementById('sale-amount').value = '';
      document.getElementById('sale-payment-status').value = 'Pending';
      document.getElementById('sale-status').value = 'Draft';
      document.getElementById('sale-due-date').value = '';
      document.getElementById('sale-notes').value = '';
      document.getElementById('installation-fields').style.display = 'none';
      document.getElementById('panels-container').innerHTML = '';
      document.getElementById('expenses-container').innerHTML = '';

      showModal('add-sale-modal');
    }

    function toggleInstallationFields() {
      const service = document.getElementById('sale-service-type').value;
      document.getElementById('installation-fields').style.display = service === 'Installation' ? 'block' : 'none';
    }

    // Dynamic field adders (generic)
    function addPanelField(containerId = 'panels-container') {
      const container = document.getElementById(containerId);
      const div = document.createElement('div');
      div.className = 'dynamic-field-row panel-item';
      div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
      div.innerHTML = `
        <input type="text" placeholder="Type" class="panel-type" style="flex:2;" required>
        <input type="number" placeholder="Qty" class="panel-qty" style="flex:1;" min="1" required>
        <input type="number" placeholder="Watts" class="panel-watts" style="flex:1;" min="1" required>
        <button type="button" class="remove-field-btn" onclick="this.parentElement.remove()">×</button>
      `;
      container.appendChild(div);
    }

    function addExpenseField(containerId = 'expenses-container') {
      const container = document.getElementById(containerId);
      const div = document.createElement('div');
      div.className = 'dynamic-field-row expense-item';
      div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
      div.innerHTML = `
        <input type="text" placeholder="Description" class="expense-desc" style="flex:2;" required>
        <input type="number" placeholder="Amount" class="expense-amt" style="flex:1;" min="0" required>
        <button type="button" class="remove-field-btn" onclick="this.parentElement.remove()">×</button>
      `;
      container.appendChild(div);
    }

    // Collect panel data from a container
    function collectPanels(containerId) {
      const container = document.getElementById(containerId);
      const panels = [];
      container.querySelectorAll('.panel-item').forEach(row => {
        const type = row.querySelector('.panel-type')?.value;
        const qty = parseInt(row.querySelector('.panel-qty')?.value);
        const watts = parseInt(row.querySelector('.panel-watts')?.value);
        if (type && !isNaN(qty) && !isNaN(watts)) {
          panels.push({ panel_type: type, quantity: qty, wattage: watts });
        }
      });
      return panels;
    }

    function collectExpenses(containerId) {
      const container = document.getElementById(containerId);
      const expenses = [];
      container.querySelectorAll('.expense-item').forEach(row => {
        const desc = row.querySelector('.expense-desc')?.value;
        const amt = parseFloat(row.querySelector('.expense-amt')?.value);
        if (desc && !isNaN(amt)) {
          expenses.push({ description: desc, amount: amt });
        }
      });
      return expenses;
    }

    async function saveSale() {
      const id = document.getElementById('sale-id').value;
      const customerId = document.getElementById('sale-customer-id').value;
      const serviceType = document.getElementById('sale-service-type').value;
      const amount = parseFloat(document.getElementById('sale-amount').value);
      const paymentStatus = document.getElementById('sale-payment-status').value;
      const saleStatus = document.getElementById('sale-status').value;
      const dueDate = document.getElementById('sale-due-date').value;
      const notes = document.getElementById('sale-notes').value;
      const existingInstallId = document.getElementById('existing-installation-id').value;

      if (!customerId || !serviceType || isNaN(amount)) { 
        showToast('Required fields missing or invalid amount', 'error'); 
        return; 
      }

      showLoader('Saving sale...');
      try {
        let savedSaleId = id;

        if (id) {
          // Update sale
          const { error } = await supabase.from('sales').update({
            customer_id: customerId, service_type: serviceType, amount,
            payment_status: paymentStatus, sale_status: saleStatus,
            due_date: dueDate || null, notes
          }).eq('id', id);
          if (error) throw error;
          showToast('Sale updated', 'success');
        } else {
          // Generate sale number
          const { data: saleNumber, error: numErr } = await supabase.rpc('generate_sale_number');
          if (numErr) throw numErr;

          // Insert sale
          const { data: newSale, error: saleErr } = await supabase
            .from('sales')
            .insert([{
              sale_number: saleNumber, customer_id: customerId, service_type: serviceType,
              amount, payment_status: paymentStatus, sale_status: saleStatus || 'Draft',
              due_date: dueDate || null, notes, created_by: currentUser.id
            }])
            .select()
            .single();
          if (saleErr) throw saleErr;
          savedSaleId = newSale.id;
          showToast('Sale created', 'success');
        }

        // Handle installation if service type is Installation
        if (serviceType === 'Installation') {
          const location = document.getElementById('install-location').value;
          const installDate = document.getElementById('install-date').value;
          const lat = document.getElementById('install-lat').value;
          const lng = document.getElementById('install-lng').value;
          const panels = collectPanels('panels-container');
          const expenses = collectExpenses('expenses-container');

          let installationId = existingInstallId; // may be empty

          // If there is an existing installation for this sale, update it; otherwise create new
          if (installationId) {
            // Update existing installation
            const { error: updErr } = await supabase
              .from('installations')
              .update({
                location_address: location,
                installation_date: installDate || null,
                location_lat: lat ? parseFloat(lat) : null,
                location_lng: lng ? parseFloat(lng) : null,
                status: 'Scheduled' // you might want to preserve existing status
              })
              .eq('id', installationId);
            if (updErr) throw updErr;

            // Delete old panels & expenses
            await supabase.from('installation_panels').delete().eq('installation_id', installationId);
            await supabase.from('installation_expenses').delete().eq('installation_id', installationId);
          } else {
            // Create new installation
            const { data: newInst, error: instErr } = await supabase
              .from('installations')
              .insert([{
                sale_id: savedSaleId,
                customer_id: customerId,
                location_address: location,
                installation_date: installDate || null,
                location_lat: lat ? parseFloat(lat) : null,
                location_lng: lng ? parseFloat(lng) : null,
                status: 'Scheduled',
                created_by: currentUser.id
              }])
              .select()
              .single();
            if (instErr) throw instErr;
            installationId = newInst.id;
          }

          // Insert new panels
          for (let p of panels) {
            const { error: pErr } = await supabase.from('installation_panels').insert([{
              installation_id: installationId,
              panel_type: p.panel_type,
              quantity: p.quantity,
              wattage: p.wattage
            }]);
            if (pErr) throw pErr;
          }

          // Insert new expenses
          for (let e of expenses) {
            const { error: eErr } = await supabase.from('installation_expenses').insert([{
              installation_id: installationId,
              description: e.description,
              amount: e.amount
            }]);
            if (eErr) throw eErr;
          }
        }

        closeModal('add-sale-modal');
        loadSales();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    async function editSale(id) {
      const sale = sales.find(s => s.id === id);
      if (!sale) return;

      // Populate customer dropdown
      const { data: custs } = await supabase.from('customers').select('id,name').order('name');
      const select = document.getElementById('sale-customer-id');
      select.innerHTML = '<option value="">Select Customer</option>';
      custs.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        if (c.id === sale.customer_id) opt.selected = true;
        select.appendChild(opt);
      });

      document.getElementById('sale-id').value = sale.id;
      document.getElementById('sale-customer-id').value = sale.customer_id;
      document.getElementById('sale-service-type').value = sale.service_type;
      document.getElementById('sale-amount').value = sale.amount;
      document.getElementById('sale-payment-status').value = sale.payment_status;
      document.getElementById('sale-status').value = sale.sale_status;
      document.getElementById('sale-due-date').value = sale.due_date ? sale.due_date.slice(0,10) : '';
      document.getElementById('sale-notes').value = sale.notes || '';

      // Load installation details if any
      if (sale.service_type === 'Installation') {
        const { data: inst } = await supabase
          .from('installations')
          .select('*')
          .eq('sale_id', sale.id)
          .single();
        if (inst) {
          document.getElementById('existing-installation-id').value = inst.id;
          document.getElementById('install-location').value = inst.location_address || '';
          document.getElementById('install-date').value = inst.installation_date ? inst.installation_date.slice(0,10) : '';
          document.getElementById('install-lat').value = inst.location_lat || '';
          document.getElementById('install-lng').value = inst.location_lng || '';

          // Load panels
          const { data: panels } = await supabase
            .from('installation_panels')
            .select('*')
            .eq('installation_id', inst.id);
          const panelContainer = document.getElementById('panels-container');
          panelContainer.innerHTML = '';
          (panels || []).forEach(p => {
            addPanelField('panels-container');
            const lastRow = panelContainer.lastElementChild;
            lastRow.querySelector('.panel-type').value = p.panel_type;
            lastRow.querySelector('.panel-qty').value = p.quantity;
            lastRow.querySelector('.panel-watts').value = p.wattage;
          });

          // Load expenses
          const { data: exps } = await supabase
            .from('installation_expenses')
            .select('*')
            .eq('installation_id', inst.id);
          const expContainer = document.getElementById('expenses-container');
          expContainer.innerHTML = '';
          (exps || []).forEach(e => {
            addExpenseField('expenses-container');
            const lastRow = expContainer.lastElementChild;
            lastRow.querySelector('.expense-desc').value = e.description;
            lastRow.querySelector('.expense-amt').value = e.amount;
          });
        }
        document.getElementById('installation-fields').style.display = 'block';
      } else {
        document.getElementById('installation-fields').style.display = 'none';
      }

      showModal('add-sale-modal');
    }

    async function deleteSale(id) {
      if (!confirm('Delete sale? This will also delete related installation data.')) return;
      showLoader('Deleting...');
      try {
        // First delete related installation panels and expenses (cascade should handle, but we do explicitly)
        const { data: inst } = await supabase.from('installations').select('id').eq('sale_id', id).maybeSingle();
        if (inst) {
          await supabase.from('installation_panels').delete().eq('installation_id', inst.id);
          await supabase.from('installation_expenses').delete().eq('installation_id', inst.id);
          await supabase.from('installations').delete().eq('id', inst.id);
        }
        const { error } = await supabase.from('sales').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        loadSales();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== INSTALLATIONS ==========
    async function loadInstallations() {
      showLoader('Loading installations...');
      try {
        const { data, error } = await supabase
          .from('installations')
          .select('*, customers(name), installation_panels(*)')
          .order('installation_date', { ascending: false });
        if (error) throw error;
        installations = data || [];
        renderInstallationsTable(installations);
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function filterInstallations() {
      const term = document.getElementById('install-search').value.toLowerCase();
      const status = document.getElementById('install-status-filter').value;
      const filtered = installations.filter(i =>
        (i.customers?.name.toLowerCase().includes(term) || (i.location_address && i.location_address.toLowerCase().includes(term))) &&
        (status === 'all' || i.status === status)
      );
      renderInstallationsTable(filtered);
    }

    function renderInstallationsTable(items) {
      const tbody = document.getElementById('installations-table-body');
      tbody.innerHTML = '';
      if (items.length) {
        items.forEach(i => {
          const panels = i.installation_panels || [];
          const totalWatts = panels.reduce((sum, p) => sum + (p.quantity * p.wattage), 0);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(i.id.slice(0,8))}</td>
            <td>${escapeHTML(i.customers?.name || '')}</td>
            <td>${escapeHTML(i.location_address || '')}</td>
            <td>${escapeHTML(panels.length)}</td>
            <td>${escapeHTML(totalWatts)}W</td>
            <td>${escapeHTML(formatDate(i.installation_date))}</td>
            <td class="text-${i.status === 'Completed' ? 'success' : (i.status === 'In Progress' ? 'warning' : 'info')}">${escapeHTML(i.status)}</td>
            <td>
              <button class="btn btn-outline btn-sm" onclick="editInstallation('${i.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteInstallation('${i.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No installations found</td></tr>';
      }
    }

    async function showAddInstallationModal() {
      // Populate sales dropdown (only Installation type, not yet linked to an installation)
      const { data: salesList } = await supabase
        .from('sales')
        .select('id, sale_number')
        .eq('service_type', 'Installation')
        .eq('sale_status', 'Confirmed');
      const saleSelect = document.getElementById('install-sale-id');
      saleSelect.innerHTML = '<option value="">Select Sale</option>';
      (salesList || []).forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.sale_number;
        saleSelect.appendChild(opt);
      });

      // Populate customers
      const { data: custs } = await supabase.from('customers').select('id,name').order('name');
      const custSelect = document.getElementById('install-customer-id');
      custSelect.innerHTML = '<option value="">Select Customer</option>';
      custs.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        custSelect.appendChild(opt);
      });

      // Reset
      document.getElementById('install-id').value = '';
      document.getElementById('install-sale-id').value = '';
      document.getElementById('install-customer-id').value = '';
      document.getElementById('install-modal-location').value = '';
      document.getElementById('install-modal-date').value = '';
      document.getElementById('install-modal-lat').value = '';
      document.getElementById('install-modal-lng').value = '';
      document.getElementById('install-panels-container').innerHTML = '';
      document.getElementById('install-expenses-container').innerHTML = '';

      showModal('add-installation-modal');
    }

    async function saveInstallation() {
      const id = document.getElementById('install-id').value;
      const saleId = document.getElementById('install-sale-id').value;
      const customerId = document.getElementById('install-customer-id').value;
      const location = document.getElementById('install-modal-location').value;
      const installDate = document.getElementById('install-modal-date').value;
      const lat = document.getElementById('install-modal-lat').value;
      const lng = document.getElementById('install-modal-lng').value;
      const panels = collectPanels('install-panels-container');
      const expenses = collectExpenses('install-expenses-container');

      if (!saleId || !customerId || !location) { 
        showToast('Required fields missing', 'error'); 
        return; 
      }

      showLoader('Saving installation...');
      try {
        let installationId = id;

        if (id) {
          // Update installation
          const { error } = await supabase.from('installations').update({
            sale_id: saleId, customer_id: customerId, location_address: location,
            installation_date: installDate || null,
            location_lat: lat ? parseFloat(lat) : null,
            location_lng: lng ? parseFloat(lng) : null
          }).eq('id', id);
          if (error) throw error;

          // Delete old panels/expenses
          await supabase.from('installation_panels').delete().eq('installation_id', id);
          await supabase.from('installation_expenses').delete().eq('installation_id', id);
        } else {
          // Insert installation
          const { data: newInst, error: instErr } = await supabase
            .from('installations')
            .insert([{
              sale_id: saleId, customer_id: customerId, location_address: location,
              installation_date: installDate || null,
              location_lat: lat ? parseFloat(lat) : null,
              location_lng: lng ? parseFloat(lng) : null,
              status: 'Scheduled',
              created_by: currentUser.id
            }])
            .select()
            .single();
          if (instErr) throw instErr;
          installationId = newInst.id;
        }

        // Insert new panels
        for (let p of panels) {
          const { error: pErr } = await supabase.from('installation_panels').insert([{
            installation_id: installationId,
            panel_type: p.panel_type,
            quantity: p.quantity,
            wattage: p.wattage
          }]);
          if (pErr) throw pErr;
        }

        // Insert new expenses
        for (let e of expenses) {
          const { error: eErr } = await supabase.from('installation_expenses').insert([{
            installation_id: installationId,
            description: e.description,
            amount: e.amount
          }]);
          if (eErr) throw eErr;
        }

        showToast('Installation saved', 'success');
        closeModal('add-installation-modal');
        loadInstallations();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    async function editInstallation(id) {
      const inst = installations.find(i => i.id === id);
      if (!inst) return;

      // Populate sales dropdown
      const { data: salesList } = await supabase
        .from('sales')
        .select('id, sale_number')
        .eq('service_type', 'Installation');
      const saleSelect = document.getElementById('install-sale-id');
      saleSelect.innerHTML = '<option value="">Select Sale</option>';
      (salesList || []).forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.sale_number;
        if (s.id === inst.sale_id) opt.selected = true;
        saleSelect.appendChild(opt);
      });

      // Populate customers
      const { data: custs } = await supabase.from('customers').select('id,name').order('name');
      const custSelect = document.getElementById('install-customer-id');
      custSelect.innerHTML = '<option value="">Select Customer</option>';
      custs.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        if (c.id === inst.customer_id) opt.selected = true;
        custSelect.appendChild(opt);
      });

      document.getElementById('install-id').value = inst.id;
      document.getElementById('install-modal-location').value = inst.location_address || '';
      document.getElementById('install-modal-date').value = inst.installation_date ? inst.installation_date.slice(0,10) : '';
      document.getElementById('install-modal-lat').value = inst.location_lat || '';
      document.getElementById('install-modal-lng').value = inst.location_lng || '';

      // Load panels
      const { data: panels } = await supabase
        .from('installation_panels')
        .select('*')
        .eq('installation_id', id);
      const panelContainer = document.getElementById('install-panels-container');
      panelContainer.innerHTML = '';
      (panels || []).forEach(p => {
        addPanelField('install-panels-container');
        const lastRow = panelContainer.lastElementChild;
        lastRow.querySelector('.panel-type').value = p.panel_type;
        lastRow.querySelector('.panel-qty').value = p.quantity;
        lastRow.querySelector('.panel-watts').value = p.wattage;
      });

      // Load expenses
      const { data: exps } = await supabase
        .from('installation_expenses')
        .select('*')
        .eq('installation_id', id);
      const expContainer = document.getElementById('install-expenses-container');
      expContainer.innerHTML = '';
      (exps || []).forEach(e => {
        addExpenseField('install-expenses-container');
        const lastRow = expContainer.lastElementChild;
        lastRow.querySelector('.expense-desc').value = e.description;
        lastRow.querySelector('.expense-amt').value = e.amount;
      });

      showModal('add-installation-modal');
    }

    async function deleteInstallation(id) {
      if (!confirm('Delete installation? This will also delete related panels and expenses.')) return;
      showLoader('Deleting...');
      try {
        await supabase.from('installation_panels').delete().eq('installation_id', id);
        await supabase.from('installation_expenses').delete().eq('installation_id', id);
        const { error } = await supabase.from('installations').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        loadInstallations();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== FINANCIALS ==========
    async function loadFinancials() {
      showLoader('Loading financials...');
      try {
        if (incomeChart) incomeChart.destroy();
        if (profitChart) profitChart.destroy();

        // Net profit
        const { data: net, error: netErr } = await supabase.rpc('get_net_profit');
        if (!netErr && net) {
          document.getElementById('total-income').innerText = formatCurrency(net.total_income);
          document.getElementById('total-expenses').innerText = formatCurrency(net.total_expense);
          document.getElementById('net-profit').innerText = formatCurrency(net.net_profit);
        }

        // Gross profit
        const { data: gross, error: grossErr } = await supabase.rpc('get_gross_profit');
        if (!grossErr && gross) {
          document.getElementById('gross-profit').innerText = formatCurrency(gross.gross_profit);
        }

        // Transactions
        const { data: txns } = await supabase.from('financial_transactions').select('*').order('transaction_date', { ascending: false }).limit(10);
        const tbody = document.getElementById('transactions-table-body');
        tbody.innerHTML = '';
        if (txns && txns.length) {
          txns.forEach(t => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${escapeHTML(formatDate(t.transaction_date))}</td>
              <td>${escapeHTML(t.description || '')}</td>
              <td class="text-${t.transaction_type === 'income' ? 'success' : 'danger'}">${escapeHTML(t.transaction_type)}</td>
              <td>${formatCurrency(t.amount)}</td>
            `;
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center">No transactions found</td></tr>';
        }

        // Income chart
        const { data: inc } = await supabase.from('financial_transactions').select('category, amount').eq('transaction_type', 'income');
        const catMap = {};
        (inc || []).forEach(i => catMap[i.category] = (catMap[i.category] || 0) + i.amount);
        incomeChart = new Chart(document.getElementById('incomeChart'), {
          type: 'bar',
          data: {
            labels: Object.keys(catMap),
            datasets: [{ label: 'Income', data: Object.values(catMap), backgroundColor: '#4caf50' }]
          }
        });

        // Profit trend
        const { data: monthly } = await supabase.rpc('get_monthly_net_profit', { months_back: 6 });
        if (monthly) {
          profitChart = new Chart(document.getElementById('profitChart'), {
            type: 'line',
            data: {
              labels: monthly.map(m => m.month),
              datasets: [{ label: 'Net Profit', data: monthly.map(m => m.profit), borderColor: '#ff9800', fill: false }]
            }
          });
        }
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    // ========== SERVICES OVERVIEW ==========
    async function loadServicesOverview() {
      const { data: salesData } = await supabase.from('sales').select('service_type, amount');
      const counts = {}, revs = {};
      (salesData || []).forEach(s => {
        counts[s.service_type] = (counts[s.service_type] || 0) + 1;
        revs[s.service_type] = (revs[s.service_type] || 0) + s.amount;
      });
      document.getElementById('contracts-count').innerText = counts['Contract'] || 0;
      document.getElementById('consultancy-count').innerText = counts['Consultancy'] || 0;
      document.getElementById('installations-count').innerText = counts['Installation'] || 0;
      document.getElementById('maintenance-count').innerText = counts['Maintenance'] || 0;
      document.getElementById('supply-count').innerText = counts['Supply'] || 0;

      const tbody = document.getElementById('services-table-body');
      tbody.innerHTML = '';
      if (Object.keys(counts).length) {
        for (let svc in counts) {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${escapeHTML(svc)}</td><td>${escapeHTML(counts[svc])}</td><td>${formatCurrency(revs[svc])}</td>`;
          tbody.appendChild(row);
        }
      } else {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">No service data</td></tr>';
      }
    }

    // ========== INIT ==========
    (async () => {
      // Check for existing session
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', session.user.id)
          .single();
        if (profile) {
          currentUser = profile;
          localStorage.setItem('alburuj_user', JSON.stringify(profile));
          document.getElementById('login-page').style.display = 'none';
          document.getElementById('app').style.display = 'block';
          document.getElementById('username-display').textContent = profile.full_name;
          document.getElementById('user-role-display').textContent = profile.role;
          updateDateDisplay();
          applyRoleVisibility(profile.role);
          showModule('dashboard-module');
        }
      }

      // Menu click handlers
      document.querySelectorAll('.sidebar-menu li').forEach(item => {
        item.addEventListener('click', function() {
          document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
          this.classList.add('active');
          const target = this.getAttribute('data-target');
          showModule(target);
        });
      });

      // Close modals on outside click (already added per modal, but also global)
      window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      };
    })();

    // Expose functions globally (for onclick handlers)
    window.login = login;
    window.logout = logout;
    window.showModule = showModule;
    window.filterCustomers = filterCustomers;
    window.filterInventory = filterInventory;
    window.filterSales = filterSales;
    window.filterInstallations = filterInstallations;
    window.showAddUserModal = showAddUserModal;
    window.saveUser = saveUser;
    window.showAddCustomerModal = showAddCustomerModal;
    window.saveCustomer = saveCustomer;
    window.editCustomer = editCustomer;
    window.deleteCustomer = deleteCustomer;
    window.showAddProductModal = showAddProductModal;
    window.saveProduct = saveProduct;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.showAddSaleModal = showAddSaleModal;
    window.toggleInstallationFields = toggleInstallationFields;
    window.addPanelField = addPanelField;
    window.addExpenseField = addExpenseField;
    window.saveSale = saveSale;
    window.editSale = editSale;
    window.deleteSale = deleteSale;
    window.showAddInstallationModal = showAddInstallationModal;
    window.saveInstallation = saveInstallation;
    window.editInstallation = editInstallation;
    window.deleteInstallation = deleteInstallation;
    window.loadDashboard = loadDashboard;
    window.loadInventory = loadInventory;
    window.loadSales = loadSales;
    window.loadInstallations = loadInstallations;
    window.loadFinancials = loadFinancials;
    window.closeModal = closeModal;
  </script>
</body>
</html>
